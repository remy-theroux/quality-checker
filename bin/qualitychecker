#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use Symfony\Component\Console\Application;
use Monolog\Logger;
use Monolog\Handler\StreamHandler;

define('APP_DIR', __DIR__ . '/..');
define('CONFIG', APP_DIR . '/config/config.yml');
$application = new Application();

try {
    $container = new \Symfony\Component\DependencyInjection\ContainerBuilder();
    $loader = new \Symfony\Component\DependencyInjection\Loader\YamlFileLoader($container, new \Symfony\Component\Config\FileLocator(__DIR__ . '/../config'));
    $loader->load('parameters.yml');
    $container->compile();
} catch (Exception $exception) {
    $application->renderException(
        $exception,
        new Symfony\Component\Console\Output\ConsoleOutput()
    );
    exit(-1);
}

// @todo Add absolute log dir in parameters
if (!is_writable(APP_DIR . $container->getParameter('log_dir'))) {
    throw new ErrorException('The logs directory is not writable. Aborting.');
}

$logPath = APP_DIR . $container->getParameter('log');

// Create logger
$logger = new Logger('app');
$logger->pushHandler(new StreamHandler($logPath));

$application->add(
    new QualityChecker\Command\StartCommand($container, $logger)
);

$application->run();